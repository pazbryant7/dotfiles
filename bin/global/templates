#!/usr/bin/env sh

BOILER_PLATE_DIR="$HOME/Documents/github/boilerplate/templates"

select_template() {
	fd --base-directory="$BOILER_PLATE_DIR" \
		--hidden \
		--type=file \
		--exclude="*.md" |
		fzf --multi --preview "bat --color=always --style=numbers $BOILER_PLATE_DIR/{}" \
			--preview-window=right:60% \
			--header="Select a template (ESC to exit)"
}

prompt_action() {
	printf "%s" "$1"
	read -r response
	[ "$response" = "y" ]
}

copy_to_clipboard() {
	filename=$(basename "$1")
	printf "Template options for: %s\n" "$filename"

	if ! prompt_action "Copy file to clipboard? (y/n) "; then
		return 0
	fi

	if cat "$1" | xclip -selection clipboard; then
		printf "✓ %s has been copied\n" "$filename"
		return 0
	fi

	printf "Failed to copy to clipboard"
	return 1
}

create_file_in_dir() {
	filename=$(basename "$1")
	dest="$(pwd)/$filename"

	printf "Template options for: %s\n" "$filename"

	if ! prompt_action "Create file in current directory? (y/n) "; then
		return 0
	fi

	if [ -f "$dest" ]; then
		if ! prompt_action "File already exist, overwrite it? (y/n) "; then
			return 0
		fi
	fi

	if cp --force "$1" "$dest"; then
		printf "✓ %s has been created\n" "$filename"
		return 0
	fi

	printf "✗ Failed to create file"
	return 1
}

validate_template() {
	template_file="$1"

	if [ ! -f "$template_file" ]; then
		printf "Error: Template file not found: %s\n" "$template_file" >&2
		return 1
	fi

	return 0
}

process_template() {
	template="$1"
	full_path="$BOILER_PLATE_DIR/$template"

	validate_template "$full_path" || return 1

	copy_to_clipboard "$full_path"
	create_file_in_dir "$full_path"
	printf "\n"
}

main() {
	selected_templates=$(select_template)

	if [ -z "$selected_templates" ]; then
		exit 1
	fi

	for template in $selected_templates; do
		process_template "$template"
	done
}

main
