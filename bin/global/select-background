#!/usr/bin/env sh
set -e

FOLDER="${HOME}/Documents/github/media/images/wallpapers"

get_palette() {
	_gp_image_path="$1"
	if [ -z "${_gp_image_path}" ]; then
		echo "Error: No image path provided." >&2
		return 1
	fi
	magick "${_gp_image_path}" +dither -colors 8 -format '%c' histogram:info: |
		sed -n 's/.*\(#[0-9A-F]\{6\}\).*/\1/p'
}

select_image() {
	nsxiv -rto "${FOLDER}"
}

set_background() {
	if [ -z "$1" ]; then
		echo "Error: No image path provided to set_background." >&2
		return 1
	fi
	feh --bg-fill "$1"
	echo "Background set to: $(basename "$1")"
}

main() {

	if [ -n "$1" ]; then
		selected_image="$1"
	else
		selected_image="$(select_image)" || {
			echo "No image selected. Exiting."
			return 1
		}
	fi

	set_background "${selected_image}"

	palete_colors="$(get_palette "${selected_image}")"
	accent_color="$(echo "$palete_colors" | sed -n '4p')"

	if [ -n "${accent_color}" ]; then
		~/bin/global/uitool "$accent_color"
	fi
}

main "$@"
