#!/usr/bin/env sh

set -e

# Configuration
THEME_RASI="$HOME/.config/rofi/theme.rasi"
TMUX_CONFIG="$HOME/.tmux.conf"
XRESOURCES="$HOME/.Xresources"
ALACRITTY_CONFIG="$HOME/.config/alacritty/alacritty.toml"
DUNSTRC="$HOME/.config/dunst/dunstrc"
STARSHIP_TOML="$HOME/.config/starship/starship.toml"

# Function to select a color using xcolor
select_color() {
	notify-send "picking color"

	xcolor || {
		echo "Failed to select color" >&2
		exit 1
	}
}

# Function to update config files with better error handling
update() {
	file="$1"
	pattern="$2"
	replacement="$3"

	if [ ! -f "$file" ]; then
		echo "Warning: File not found: $file" >&2
		return 1
	fi

	if sed -i "s|$pattern|$replacement|" "$file"; then
		return 0
	else
		echo "Error: Failed to update $file" >&2
		return 1
	fi
}

overwrite_rofi_colors() {
	accent_color="$1"
	update "$THEME_RASI" \
		'background-alt:\s*#[0-9a-fA-F]\{6\};' \
		"background-alt:\t\t\t$accent_color;"
}

overwrite_tmux_colors() {
	accent_color="$1"
	update "$TMUX_CONFIG" \
		"set-option -g status-style 'bg=#1e1e2e,fg=#[0-9a-fA-F]\{6\}'" \
		"set-option -g status-style 'bg=#1e1e2e,fg=$accent_color'"
}

overwrite_xresources_colors() {
	accent_color="$1"
	brighter_color="$2"

	update "$XRESOURCES" '*.cursorColor:[[:space:]]*#[0-9a-fA-F]\{6\}' \
		"*.cursorColor: $brighter_color" || true

	update "$XRESOURCES" 'dwm.selbgcolor: #[0-9a-fA-F]\{6\}' \
		"dwm.selbgcolor: $accent_color" || true

	update "$XRESOURCES" 'dwm.selbordercolor: #[0-9a-fA-F]\{6\}' \
		"dwm.selbordercolor: $accent_color" || true
}

overwrite_alacritty_colors() {
	accent_color="$1"
	update "$ALACRITTY_CONFIG" \
		'cursor = "#[0-9a-fA-F]\{6\}"' \
		"cursor = \"$accent_color\""
}

overwrite_dunst_colors() {
	accent_color="$1"
	update "$DUNSTRC" \
		'background = "#[0-9a-fA-F]\{6\}"' \
		"background = \"$accent_color\""
}

overwrite_starship_colors() {
	brighter_color="$1"

	update "$STARSHIP_TOML" \
		'success_symbol = "\[󰁕\](bold #[0-9a-fA-F]\{6\})"' \
		"success_symbol = \"[󰁕](bold $brighter_color)\"" || true

	update "$STARSHIP_TOML" \
		'style = "bold #[0-9a-fA-F]\{6\}"' \
		"style = \"bold $brighter_color\"" || true
}

# Reload services after configuration updates
reload_services() {
	# Reload Xresources and signal st terminals
	if [ -f "$XRESOURCES" ]; then
		if xrdb -merge "$XRESOURCES"; then
			pgrep -x st | while IFS= read -r pid; do
				kill -USR1 "$pid" 2>/dev/null || echo "Warning: Failed to signal st PID: $pid"
			done
		else
			echo "Warning: xrdb -merge failed" >&2
		fi
	fi

	# Reload qutebrowser
	pgrep -x qutebrowser >/dev/null && qutebrowser :config-source

	# Reload dunst
	if pgrep -x dunst >/dev/null; then
		pkill dunst
		while pgrep -x dunst >/dev/null; do
			sleep 0.1
		done
	fi

	# Reload dwm
	pgrep -x dwm >/dev/null && xsetroot -name "fsignal:1" || echo "Warning: Failed to signal dwm" >&2

	if pgrep tmux >/dev/null; then
		tmux source-file "${HOME}/.tmux.conf" || echo "Failed to reload tmux configuration"
	fi
}

# Validate hex color format
validate_color() {
	echo "$1" | grep -qE '^#[0-9a-fA-F]{6}$'
}

get_brighter_color() {
	accent_color="$1"
	pastel lighten 0.25 "$accent_color" |
		pastel format hex
}

# Main function
main() {
	accent_color=""

	if [ -n "$1" ]; then
		accent_color="$1"
	else
		accent_color=$(select_color)
	fi

	if [ -z "$accent_color" ]; then
		echo "Error: No color selected or provided. Exiting." >&2
		exit 1
	fi

	if ! validate_color "$accent_color"; then
		echo "Error: Invalid color format: $accent_color. Expected #RRGGBB." >&2
		exit 1
	fi

	brighter_color=$(get_brighter_color "$accent_color")

	# Update all configuration files in parallel
	overwrite_rofi_colors "$accent_color" &
	overwrite_dunst_colors "$accent_color" &
	overwrite_tmux_colors "$accent_color" &
	overwrite_alacritty_colors "$accent_color" &

	echo "$brighter_color"

	overwrite_starship_colors "$brighter_color" &
	overwrite_xresources_colors "$accent_color" \
		"$brighter_color" &

	# Wait for all background jobs to complete
	wait

	# Reload services
	reload_services

	echo "Theme updated successfully with color \
		$accent_color and color $brighter_color"
}

main "$@"
