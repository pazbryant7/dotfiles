#!/bin/sh

usage() {
	printf 'Usage: %s FILE_PATH\n' "${0##*/}"
	exit 1
}

validate_file() {
	file="$1"

	if [ ! -e "$file" ]; then
		printf 'Error: File "%s" does not exist\n' "$file"
		return 1
	fi

	return 0
}

select_desktop_file() {
	desktop=$(fd '.desktop' . /usr/share/applications --type=file |
		xargs -I {} basename '{}' |
		fzf) || return 1

	if [ -z "$desktop" ]; then
		printf 'Error: No desktop file selected\n'
		return 1
	fi

	printf '%s' "$desktop"
	return 0
}

get_mime_type() {
	file="$1"

	mime_type=$(xdg-mime query filetype "$file") || {
		printf 'Error: Failed to determine MIME type\n'
		return 1
	}

	if [ -z "$mime_type" ]; then
		printf 'Error: MIME type is empty\n'
		return 1
	fi

	printf '%s' "$mime_type"
	return 0
}

set_default_application() {
	desktop="$1"
	mime_type="$2"

	if xdg-mime default "$desktop" "$mime_type"; then
		printf 'Successfully set default application:\n'
		printf 'MIME type: %s\n' "$mime_type"
		printf 'Application: %s\n' "$desktop"
		return 0
	fi

	printf 'Error: Failed to set default application\n'
	return 1
}

main() {
	[ $# -eq 1 ] || usage

	file="$1"

	validate_file "$file" || exit 1

	desktop=$(select_desktop_file) || {
		printf 'Error: Failed to select desktop file\n'
		exit 1
	}

	mime_type=$(get_mime_type "$file") || exit 1

	set_default_application "$desktop" "$mime_type" || exit 1
}

main "$@"
