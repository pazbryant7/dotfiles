#!/bin/env sh

OUTPUT="HDMI-2"
RANDR_METHOD="randr"
WARM_COLOR_TEMP="4200K"
DEFAULT_COLOR_TEMP="6500K"

prompt_brightness() {
	rofi -dmenu -p "Enter brightness (0-9 or 0.0-1.0):" -lines 1
}

normalize_brightness() {
	brightness="$1"

	case "$brightness" in
	1) brightness="1.00" ;;
	2) brightness="0.80" ;;
	3) brightness="0.60" ;;
	4) brightness="0.40" ;;
	5) brightness="0.30" ;;
	6) brightness="0.20" ;;
	7) brightness="0.10" ;;
	esac

	echo "$brightness"
}

get_current_color_temp() {
	gamma="$(xrandr --verbose | awk '/Gamma:/ { print $2 }')"

	color_temp="$DEFAULT_COLOR_TEMP"
	warm_gamma="1.0:1.2:1.5"

	if [ "$gamma" = "$warm_gamma" ]; then
		color_temp="$WARM_COLOR_TEMP"
	fi

	echo "$color_temp"
}

apply_brightness() {
	brightness="$1"
	color_temp="$2"

	echo "$brightness"
	echo "$color_temp"

	max_gammastep_brightness="1.00"

	if awk "BEGIN { exit !($brightness > $max_gammastep_brightness) }"; then
		xrandr --output "$OUTPUT" --brightness "$brightness"
	else
		gammastep -m "$RANDR_METHOD" -P -O "$color_temp" -b "$brightness"
	fi
}

main() {
	brightness="$(prompt_brightness)"
	[ -z "$brightness" ] && exit 0

	color_temp="$(get_current_color_temp)"
	brightness="$(normalize_brightness "$brightness")"

	apply_brightness "$brightness" "$color_temp"
}

main "$@"
