#!/bin/env sh

get_password_entries() {
	fd -t f -e gpg --base-directory "$1"
}

normalize_passwords() {
	printf '%s\n' "$1" |
		sed -e 's/\.gpg$//' \
			-e 's#^pass-dev/#dev/#' \
			-e 's#^pass/##' |
		sort
}

get_password_entry() {
	printf '%s\n' "$1" | rofi -dmenu -i -p 'Select item'
}

get_credentials() {
	if [ "$1" = "otp" ]; then
		gopass otp "$2" 2>/dev/null
	else
		gopass "$2" 2>/dev/null
	fi
}

get_password() {
	printf '%s' "$1" | head -n 1
}

get_user_name() {
	printf '%s' "$1" | rg "username" | awk '{print $2}'
}

copy_to_clipboard() {
	printf '%s' "$1" | xclip -selection clipboard
}

send_username_notification() {
	notify-send "$1"
}

main() {
	mode="${1:-pass}"
	passwd_dir="$HOME/Documents/github"
	entries=$(get_password_entries "$passwd_dir") || exit 1
	[ -n "$entries" ] || exit 0

	normalized=$(normalize_passwords "$entries")
	selected=$(get_password_entry "$normalized") || exit 0

	creds=$(get_credentials "$mode" "$selected") || exit 1
	[ -n "$creds" ] || exit 1

	password=$(get_password "$creds")

	username=$(get_user_name "$creds")

	[ -n "$password" ] || exit 1

	copy_to_clipboard "$password"
	[ -z "$username" ] || send_username_notification "$username"
}

main "$@"
