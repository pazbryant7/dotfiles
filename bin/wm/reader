#!/bin/env sh

BOOKS_DIR="$HOME/Documents/books"
LAST_READ_BOOK_PATH="$HOME/.last-read-book"

list_files_in_folder() {
	fd --type f --base-directory "$BOOKS_DIR"
}

select_book() {
	list_files_in_folder | rofi -dmenu -i -p "Select book"
}

get_last_book() {
	[ -f "$LAST_READ_BOOK_PATH" ] && cat "$LAST_READ_BOOK_PATH"
}

update_last_read_book() {
	echo "$1" >"$LAST_READ_BOOK_PATH"
}

prompt_last_read_book() {
	last_read_book_path=$(get_last_book)

	if [ -z "$last_read_book_path" ]; then
		return
	fi

	last_read_book_filename=$(basename "$last_read_book_path")
	read_option=$(printf "Read last book: %s" "$last_read_book_filename" | rofi -dmenu -i -p "Select Action:")

	if [ "$read_option" = "Read last book: $last_read_book_filename" ]; then
		zathura "$last_read_book_path"
		exit 0
	fi
}

main() {
	prompt_last_read_book

	selected_book=$(select_book)

	if [ -z "$selected_book" ]; then
		echo "No book selected. Exiting." >&2
		exit 1
	fi

	selected_book_file_path="$BOOKS_DIR/$selected_book"
	update_last_read_book "$selected_book_file_path"
	zathura "$selected_book_file_path" &
}

main
