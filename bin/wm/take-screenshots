#!/usr/bin/env sh

DIR="${HOME}/Pictures/screenshots"
TIME=$(date +%Y-%m-%d-%H-%M-%S)
FILE="${DIR}/screenshot_${TIME}.png"

notify_send() {
	notify-send -a "sshot" --replace=699 "$@"
}

countdown() {
	sec="$1"
	while [ "$sec" -gt 0 ]; do
		notify_send -t 1000 "taking shot in: $sec"
		sec=$((sec - 1))
		sleep 1
	done
}

build_command() {
	cmd="maim -u -f png"

	case "$mode" in
	select)
		cmd="$cmd -s -b 2 -c 0.35,0.55,0.85,0.25 -l"
		;;
	win)
		cmd="$cmd -i $(xdotool getactivewindow)"
		;;
	full) ;;
	*)
		echo "Invalid mode: $mode" >&2
		return 1
		;;
	esac

	printf '%s' "$cmd"
	return 0
}

execute_screenshot() {
	cmd=$(build_command) || return 1
	cmd="${cmd} \"${FILE}\""

	if eval "$cmd"; then
		notify_send -u normal "screenshot saved"
		return 0
	else
		notify_send -u normal "screenshot failed"
		return 1
	fi
}

handle_storage() {
	case "$store" in
	clip)
		xclip -selection clipboard -t image/png <"$FILE"
		rm "$FILE"
		;;
	clip\&save)
		xclip -selection clipboard -t image/png <"$FILE"
		;;
	esac
}

main() {
	mode="full"
	store="clip&save"
	wait_time=0

	while getopts "m:s:w:" opt; do
		case "$opt" in
		m) mode="$OPTARG" ;;
		s) store="$OPTARG" ;;
		w) wait_time="$OPTARG" ;;
		*) ;;
		esac
	done

	mkdir -p "$DIR"

	if [ "$wait_time" -gt 0 ]; then
		countdown "$wait_time"
	fi

	execute_screenshot || exit 1
	handle_storage

	exit 0
}

main "$@"
