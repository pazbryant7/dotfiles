#!/usr/bin/env sh

set -e

VIDEOS_DIR="/home/bryant/Videos/"
RECORDINGS_DIR="/run/media/bryant/tiagovault/videos/"
LAST_WATCHED_FILE="/home/bryant/.last-watched"

list_video_dirs() {
	fd . --type=d --max-depth 1 "$VIDEOS_DIR" "$RECORDINGS_DIR" 2>/dev/null
}

list_videos() {
	fd --base-directory "$1" \
		--glob '*.{mp4,mkv,avi,mov,m4v,webm,flv,wmv,mpeg,mpg}' \
		2>/dev/null
}

prompt_dir() {
	printf '%s\n' "$1" | rofi -dmenu -i -p "Select directory"
}

prompt_video() {
	printf '%s\n' "$1" | rofi -dmenu -i -p "Select file"
}

prompt_resume() {
	name=$(basename "$1")
	printf "Yes\nNo" | rofi -dmenu -i -p "Resume? $name:" || echo "No"
}

play_video() {
	exec mpv "$1"
}

save_last_watched() {
	printf '%s' "$1" >"$LAST_WATCHED_FILE" || return 1
}

get_last_watched() {
	cat "$LAST_WATCHED_FILE" 2>/dev/null
}

try_resume() {
	path=$(get_last_watched) || return
	[ -z "$path" ] && return
	[ -f "$path" ] || return

	choice=$(prompt_resume "$path")
	[ "$choice" = "Yes" ] && play_video "$path"
}

build_path() {
	dir="$1"
	file="$2"
	case "$dir" in
	*/) printf '%s%s' "$dir" "$file" ;;
	*) printf '%s/%s' "$dir" "$file" ;;
	esac
}

main() {
	try_resume || true

	dirs=$(list_video_dirs) || exit 1
	[ -z "$dirs" ] && exit 1

	dir=$(prompt_dir "$dirs") || exit 1
	[ -z "$dir" ] && exit 1
	[ ! -d "$dir" ] && exit 1

	videos=$(list_videos "$dir") || exit 1
	[ -z "$videos" ] && exit 1

	video=$(prompt_video "$videos") || exit 1
	[ -z "$video" ] && exit 1

	path=$(build_path "$dir" "$video")
	[ ! -f "$path" ] && exit 1

	save_last_watched "$path"
	play_video "$path"
}

main
