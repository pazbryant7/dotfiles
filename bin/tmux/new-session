#!/usr/bin/env sh

# Inspired by ThePrimeAgen
# Open, switch, create, and navigate tmux sessions quickly

select_session_path() {
	if [ -n "$1" ]; then
		printf '%s' "$1"
		return 0
	fi
	fd . \
		--max-depth 1 \
		--type=d \
		--type=l \
		--follow \
		"$HOME/Documents/github/" \
		"$HOME/Documents/github/temp" \
		"$HOME/Downloads/" 2>/dev/null | fzf
}

select_session_name() {
	if [ -n "$1" ]; then
		printf '%s' "$1"
	else
		basename "$2" | tr . _
	fi
}

get_current_session() {
	tmux display-message -p '#S'
}

session_exists() {
	tmux has-session -t="$1" 2>/dev/null
}

create_session() {
	tmux new-session -ds "$1" -c "$2"
}

switch_to_session() {
	tmux switch-client -t "$1"
}

rfresh_status() {
	tmux refresh-client -S
}

nuke_and_recreate_session() {
	session_name="$1"
	path="$2"
	temp_session="__temp_switch_$"

	create_session "$temp_session" "$HOME"
	switch_to_session "$temp_session"
	tmux kill-session -t "$session_name" 2>/dev/null
	create_session "$session_name" "$path"
	switch_to_session "$session_name"
	tmux kill-session -t "$temp_session" 2>/dev/null
	refresh_status
}

validate_session_args() {
	if [ -z "$1" ] || [ -z "$2" ]; then
		printf 'Error: session name and path are required\n' >&2
		return 1
	fi

	if [ -z "$TMUX" ]; then
		printf 'Error: not inside a tmux session\n' >&2
		return 1
	fi
}

switch_session() {
	session_name="$1"
	path="$2"
	nuke_session="$3"

	validate_session_args "$session_name" "$path" || return 1

	if [ "$session_name" = "working" ] && [ -n "$nuke_session" ]; then
		nuke_and_recreate_session "$session_name" "$path"
		return 0
	fi

	if [ "$(get_current_session)" = "$session_name" ]; then
		tmux display-message "Already attached to session: $session_name"
		return 0
	fi

	session_exists "$session_name" || create_session "$session_name" "$path"
	switch_to_session "$session_name"
}

destroy_current_pane() {
	tmux kill-pane
}

main() {
	input_path="$1"
	input_session_name="$2"
	input_nuke_session="$3"

	selected_path=$(select_session_path "$input_path") || exit 1

	if [ -z "$selected_path" ]; then
		printf 'No path selected\n' >&2
		exit 1
	fi

	selected_session_name=$(select_session_name "$input_session_name" "$selected_path")
	switch_session "$selected_session_name" "$selected_path" "$input_nuke_session"
	destroy_current_pane
}

main "$@"
