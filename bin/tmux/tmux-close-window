#!/usr/bin/env sh

pane_count=$(tmux list-panes | wc -l)
window_count=$(tmux list-windows | wc -l)
session_count=$(tmux list-sessions | wc -l)
current_session=$(tmux display-message -p '#S')

switch_to_last_session() {
	if [ "$session_count" -gt 1 ]; then
		tmux switch-client -l 2>/dev/null || {
			other_session=$(tmux list-sessions -F '#{session_name}' | grep -v "^${current_session}$" | head -n 1)
			tmux switch-client -t "$other_session"
		}
		tmux kill-session -t "$current_session"
	else
		tmux kill-session
	fi
}

if [ "$pane_count" -gt 1 ]; then
	tmux kill-pane
elif [ "$window_count" -gt 1 ]; then
	tmux kill-window
else
	switch_to_last_session
fi

tmux refresh-client -S
